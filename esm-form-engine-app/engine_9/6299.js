"use strict";(globalThis.webpackChunk_openmrs_esm_form_engine_app=globalThis.webpackChunk_openmrs_esm_form_engine_app||[]).push([[6299],{56299:(n,e,t)=>{t.r(e),t.d(e,{ProgramEnrollmentSubmissionAction:()=>c,default:()=>p});var r=t(7040),o=t.n(r),i=t(10881),l=t(28060),a=t(6519),u=t(31031);function s(n,e,t,r,o,i,l){try{var a=n[i](l),u=a.value}catch(n){return void t(n)}a.done?e(u):Promise.resolve(u).then(r,o)}var c={applyAction:function(n,e){return(t=function(n,e){var t,r,s,c,p,m,h,b,w,v,y,g,k,C,E,D,P;return function(n,e){var t,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},l=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return l.next=a(0),l.throw=a(1),l.return=a(2),"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function a(a){return function(u){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;l&&(l=0,a[0]&&(i=0)),i;)try{if(t=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(n,i)}catch(n){a=[6,n],r=0}finally{t=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}(this,(function(_){switch(_.label){case 0:if(t=n.patient,r=n.encounters,s=n.sessionMode,b=r[0],w=b.location.uuid,v=function(n,e,t){return(0,i.translateFrom)(a.L,n,e,t)},y=e.programUuid,"view"===s)return[2];if(!y)throw new Error("Program UUID not configured");return g=null===(p=b.obs)||void 0===p||null===(c=p.find((function(n){return n.formFieldPath.includes(e.enrollmentDate||null)})))||void 0===c?void 0:c.value,k=null===(h=b.obs)||void 0===h||null===(m=h.find((function(n){return n.formFieldPath.includes(e.completionDate||null)})))||void 0===m?void 0:m.value,C=new AbortController,E={patient:t.id,program:y,dateEnrolled:null!=g?g:o()().format(),location:w},[4,(0,l.getPatientEnrolledPrograms)(t.id)];case 1:if(D=_.sent(),P=null==D?void 0:D.results.find((function(n){return n.program.uuid===y&&!n.dateCompleted})),e.completionDate){if(!k)throw new Error("Completion date was not found in the encounter");if(!P)return(0,i.showSnackbar)({title:v("enrollmentDiscontinuationNotAllowed","Enrollment discontinuation not allowed"),subtitle:v("cannotDiscontinueEnrollment","Cannot discontinue an enrollment that does not exist"),kind:"error",isLowContrast:!1}),[2];E={uuid:P.uuid,dateCompleted:f(k)}}if(P){if(!P.dateCompleted&&!k)return"enter"===s&&(0,i.showSnackbar)({title:v("enrollmentNotAllowed","Enrollment not allowed"),subtitle:v("alreadyEnrolledDescription","This patient is already enrolled in the selected program and cannot be enrolled again."),kind:"error",isLowContrast:!1}),[2];if(P.dateCompleted)return"enter"===s&&(0,i.showSnackbar)({title:v("enrollmentAlreadyDiscontinued","Enrollment already discontinued"),subtitle:v("alreadyDiscontinuedDescription","This patient is already enrolled in the selected program and has already been discontinued."),kind:"error",isLowContrast:!1}),[2]}return(0,l.saveProgramEnrollment)(E,C).then((function(n){(0,i.showSnackbar)({kind:"success",title:d(v,n),isLowContrast:!0})}),(function(n){(0,i.showSnackbar)({title:v("errorSavingEnrollment","Error saving enrollment"),subtitle:(0,u.j)(n).join(", "),kind:"error",isLowContrast:!1})})),[2]}}))},function(){var n=this,e=arguments;return new Promise((function(r,o){var i=t.apply(n,e);function l(n){s(i,r,o,l,a,"next",n)}function a(n){s(i,r,o,l,a,"throw",n)}l(void 0)}))}).apply(this,arguments);var t}};function d(n,e){return e.data.dateCompleted?n("enrollmentDiscontinued","The patient's program enrollment has been successfully discontinued."):n("enrolledToProgram","The patient has been successfully enrolled in the program.")}function f(n){if(!n.endsWith("T00:00:00.000+0000"))return n;var e=o()();return o()(n).hour(e.hour()).minute(e.minute()).second(e.second()).millisecond(e.millisecond()).format()}const p=c}}]);